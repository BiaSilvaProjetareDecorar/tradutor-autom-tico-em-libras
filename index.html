// Substitua o bloco de script atual (linhas 50 até o final do script) por este:
    <script id="codigo-asr">
        const saidaTexto = document.getElementById('saida-texto');
        const iniciarBtn = document.getElementById('iniciar');
        const pararBtn = document.getElementById('parar');

        // Habilita os botões e remove a lógica de espera que travou
        iniciarBtn.disabled = false;
        pararBtn.disabled = false;
        iniciarBtn.style.backgroundColor = 'green';
        iniciarBtn.innerText = 'Iniciar Microfone';
        saidaTexto.innerHTML = 'Clique em "Iniciar Microfone". A tradução adaptada abrirá em uma nova aba.';
        
        // Verifica se a API de Reconhecimento de Fala está disponível
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            saidaTexto.innerText = "ERRO: O seu navegador não suporta o Reconhecimento de Fala. Tente usar o Google Chrome.";
            iniciarBtn.disabled = true;
        } else {
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.interimResults = true;
            
            let finalTranscript = '';

            // Lógica ao receber um resultado de fala
            recognition.onresult = (event) => {
                let interimTranscript = '';
                finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Exibe o texto em tempo real (provavelmente final + interim)
                saidaTexto.innerText = `Original: ${finalTranscript + interimTranscript}`;
            };

            // Lógica ao terminar de capturar um bloco de fala
            recognition.onend = () => {
                iniciarBtn.style.backgroundColor = 'green';
                iniciarBtn.innerText = 'Iniciar Microfone';
                
                if (finalTranscript.trim().length > 0) {
                    // CHAMA A FUNÇÃO DE REGRAS E ADAPTAÇÃO
                    const textoCorrigido = aplicarRegrasDeLibras(finalTranscript.trim());
                    
                    saidaTexto.innerText = `Original: ${finalTranscript}\n(Tradução adaptada: "${textoCorrigido}")`;
                    
                    // JOGA O TEXTO CORRIGIDO NO VLIBRAS (SOLUÇÃO DE REDIRECIONAMENTO)
                    const linkVLibras = `https://vlibras.gov.br/tradutor/?text=${encodeURIComponent(textoCorrigido)}`;

                    // Abre a tradução em uma nova aba para o usuário ver o avatar funcionando
                    window.open(linkVLibras, '_blank');
                    
                    saidaTexto.innerText += `\n(A tradução completa abriu em uma nova aba para visualização do avatar!)`;
                }
            };

            // Botão Iniciar
            iniciarBtn.addEventListener('click', () => {
                finalTranscript = ''; // Limpa antes de começar
                recognition.start();
                iniciarBtn.style.backgroundColor = 'orange';
                iniciarBtn.innerText = 'Gravando...';
            });

            // Botão Parar
            pararBtn.addEventListener('click', () => {
                recognition.stop();
                iniciarBtn.style.backgroundColor = 'green';
                iniciarBtn.innerText = 'Iniciar Microfone';
            });
            
            // Tratamento de erro
            recognition.onerror = (event) => {
                console.error(event.error);
                if (event.error === 'not-allowed') {
                     saidaTexto.innerText = "Erro: Acesso ao microfone negado. Por favor, permita o uso do microfone nas configurações do navegador.";
                } else {
                    saidaTexto.innerText = `Erro na transcrição: ${event.error}`;
                }
                iniciarBtn.style.backgroundColor = 'green';
                iniciarBtn.innerText = 'Iniciar Microfone';
            };
            
            // ----------------------------------------------------------------
            // *** FASE 3: O CÉREBRO - FUNÇÃO DE REGRAS DE ADAPTAÇÃO PARA LIBRAS (O foco principal) ***
            // ----------------------------------------------------------------
            function aplicarRegrasDeLibras(textoOriginal) {
                // ... (Regras de adaptação continuam as mesmas - este é o seu principal foco agora) ...
                let textoCorrigido = textoOriginal.toLowerCase();
                textoCorrigido = textoCorrigido.replace(/\btá bom\b/g, 'ok');
                textoCorrigido = textoCorrigido.replace(/\ba gente\b/g, 'nós');
                textoCorrigido = textoCorrigido.replace(/\bmeu\b/g, 'eu');
                textoCorrigido = textoCorrigido.replace(/\bminha\b/g, 'eu');
                textoCorrigido = textoCorrigido.replace(/\bsapo\b/g, 'saber'); 
                textoCorrigido = textoCorrigido.replace(/\bque a\b/g, ''); 
                
                if (textoCorrigido.includes('amanhã')) {
                    textoCorrigido = textoCorrigido.replace('amanhã', '').trim();
                    textoCorrigido = 'amanhã ' + textoCorrigido;
                }
                
                if (textoCorrigido.includes(' não ')) {
                    textoCorrigido = textoCorrigido.replace(' não ', ' ');
                    textoCorrigido = textoCorrigido.trim() + ' NÃO';
                }

                textoCorrigido = textoCorrigido.replace(/\b(o|a|os|as|um|uma|uns|umas|de|da|do|e|em)\b/g, '').trim();
                textoCorrigido = textoCorrigido.replace(/[.?]/g, '');
                textoCorrigido = textoCorrigido.replace(/\s+/g, ' ').trim();

                return textoCorrigido.toUpperCase();
            }
        }
    </script>
